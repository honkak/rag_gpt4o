import os
import tkinter as tk
from tkinter import ttk, scrolledtext
from langchain_openai import OpenAIEmbeddings, ChatOpenAI
from langchain_community.vectorstores import Chroma
from langchain_community.document_loaders import TextLoader
from langchain.text_splitter import RecursiveCharacterTextSplitter
from langchain.chains import RetrievalQA

# OpenAI API í‚¤ ì„¤ì • (í™˜ê²½ ë³€ìˆ˜ì— ë„£ê¸°)
os.environ["OPENAI_API_KEY"] = "api"  # ì‹¤ì œ í‚¤ë¡œ êµì²´ í•„ìš”

# ë¬¸ì„œ ë¡œë”© ë° ë¶„í• 
loader = TextLoader("insa.txt", encoding="utf-8")
documents = loader.load()
text_splitter = RecursiveCharacterTextSplitter(chunk_size=300, chunk_overlap=30)
docs = text_splitter.split_documents(documents)

# ì„ë² ë”© ë° ë²¡í„° ìŠ¤í† ì–´ ì„¤ì •
embeddings = OpenAIEmbeddings()
vector_store = Chroma.from_documents(docs, embeddings, persist_directory=None)

# GUI í´ë˜ìŠ¤ ì •ì˜
class ChatApp:
    def __init__(self, master):
        self.master = master
        master.title("LangChain GPT ëŒ€í™”ì°½")
        master.geometry("700x650")
        master.configure(bg="#f7f7f7")

        # ì±„íŒ… ì˜ì—­ (ë§‘ì€ ê³ ë”• ê¸€ê¼´ë¡œ ì„¤ì •)
        self.chat_area = scrolledtext.ScrolledText(
            master, wrap=tk.WORD, width=80, height=25, font=("Malgun Gothic", 11), bg="white"
        )
        self.chat_area.pack(pady=10, padx=10)
        self.chat_area.insert(tk.END, "ğŸ’¬ LangChain GPTì— ì§ˆë¬¸í•´ë³´ì„¸ìš”!\n\n")

        # ì‘ë‹µ ê¸¸ì´ ì„ íƒ
        self.length_var = tk.StringVar(value="ì¤‘ê°„")
        length_frame = tk.Frame(master, bg="#f7f7f7")
        length_frame.pack(pady=5)

        tk.Label(length_frame, text="ë‹µë³€ ê¸¸ì´ ì„ íƒ:", bg="#f7f7f7", font=("Malgun Gothic", 10)).pack(side=tk.LEFT)
        for label in ["ì§§ê²Œ", "ì¤‘ê°„", "ê¸¸ê²Œ"]:
            tk.Radiobutton(
                length_frame,
                text=label,
                variable=self.length_var,
                value=label,
                bg="#f7f7f7",
                font=("Malgun Gothic", 10)
            ).pack(side=tk.LEFT, padx=5)

        # ì§ˆë¬¸ ì…ë ¥ì°½ (ë§‘ì€ ê³ ë”• ê¸€ê¼´ë¡œ ì„¤ì •)
        input_frame = tk.Frame(master, bg="#f7f7f7")
        input_frame.pack(pady=10)
        self.entry = tk.Entry(input_frame, width=60, font=("Malgun Gothic", 11))  # ê¸€ê¼´ ì¶”ê°€
        self.entry.pack(side=tk.LEFT, padx=5)
        self.entry.bind("<Return>", self.ask_question)

        # ë²„íŠ¼
        self.ask_button = tk.Button(input_frame, text="ì§ˆë¬¸í•˜ê¸°", command=self.ask_question, font=("Malgun Gothic", 10))
        self.ask_button.pack(side=tk.LEFT)

    def get_max_tokens(self):
        selection = self.length_var.get()
        return {"ì§§ê²Œ": 256, "ì¤‘ê°„": 1024, "ê¸¸ê²Œ": 2048}.get(selection, 1024)

    def ask_question(self, event=None):
        user_query = self.entry.get().strip()
        if not user_query:
            return

        self.chat_area.insert(tk.END, f"\nğŸ‘¤ ì§ˆë¬¸: {user_query}\n\n")  # ì§ˆë¬¸ê³¼ ë‹µë³€ ì‚¬ì´ì— ê³µë°± ì¶”ê°€
        self.chat_area.see(tk.END)

        # max_tokens ì„¤ì •
        max_tokens = self.get_max_tokens()

        # LLM ë° QA ì²´ì¸ ì„¤ì •
        llm = ChatOpenAI(model_name="gpt-4o", temperature=0, max_tokens=max_tokens)
        qa_chain = RetrievalQA.from_chain_type(
            llm=llm,
            chain_type="stuff",
            retriever=vector_store.as_retriever(search_kwargs={"k": 3}),
            return_source_documents=True
        )

        # ë‹µë³€ ì‹¤í–‰
        result = qa_chain.invoke({"query": user_query})
        self.chat_area.insert(tk.END, f"ğŸ¤– ë‹µë³€: {result['result']}\n\n")  # ë‹µë³€ í›„ì— ê³µë°± ì¶”ê°€
        self.chat_area.see(tk.END)

        self.entry.delete(0, tk.END)

# GUI ì‹¤í–‰
if __name__ == "__main__":
    root = tk.Tk()
    app = ChatApp(root)
    root.mainloop()
